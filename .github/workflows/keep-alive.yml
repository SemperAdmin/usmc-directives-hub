# GitHub Actions Workflow to Keep Render.com Proxy Server Alive
# Prevents cold starts on free tier by pinging every 14 minutes

name: Keep Render Alive

on:
  # Run every 14 minutes (just under Render's 15-minute timeout)
  schedule:
    - cron: '*/14 * * * *'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest

    steps:
      - name: Ping health endpoint
        run: |
          echo "ðŸ“ Pinging proxy server to keep it alive..."

          # Ping the health endpoint with increased timeout
          # Catch curl errors (e.g., timeout exit code 28) to prevent workflow failure
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 60 \
            https://usmc-directives-proxy.onrender.com/health) || RESPONSE="timeout"

          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… Server is alive (HTTP $RESPONSE)"
          elif [ "$RESPONSE" = "timeout" ]; then
            echo "âš ï¸  Request timed out after 60 seconds (server may be cold-starting)"
          else
            echo "âš ï¸  Server returned HTTP $RESPONSE"
          fi

          # Don't fail the workflow - this is just a keep-alive ping

      - name: Create summary
        if: always()
        run: |
          echo "## Keep-Alive Ping Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow pings the proxy server every 14 minutes to prevent cold starts on Render's free tier." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server URL:** https://usmc-directives-proxy.onrender.com" >> $GITHUB_STEP_SUMMARY
