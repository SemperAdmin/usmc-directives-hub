# GitHub Actions Workflow for Deploying Proxy Server
# This workflow uses GitHub Repository Secrets for API keys

name: Deploy Proxy Server

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'proxy-server/**'
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: proxy-server/package-lock.json

      - name: Install dependencies
        working-directory: ./proxy-server
        run: npm ci

      - name: Run tests (if you have any)
        working-directory: ./proxy-server
        run: |
          # npm test (uncomment when you add tests)
          echo "No tests configured yet"

      # Example: Deploy to Render.com
      - name: Deploy to Render
        if: github.ref == 'refs/heads/main'
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "Deploying to Render..."
          # Render will automatically use GitHub Secrets if configured in Render dashboard
          # Alternatively use Render API:
          # curl -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
          #   -H "Authorization: Bearer ${RENDER_API_KEY}" \
          #   -H "Content-Type: application/json"

      # Example: Deploy to Heroku
      - name: Deploy to Heroku
        if: false # Set to true to enable Heroku deployment
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
          HEROKU_APP_NAME: usmc-directives-proxy
        run: |
          # Install Heroku CLI
          curl https://cli-assets.heroku.com/install.sh | sh

          # Set Heroku config vars (environment variables) using GitHub Secrets
          heroku config:set YOUTUBE_API_KEY="${{ secrets.YOUTUBE_API_KEY }}" --app $HEROKU_APP_NAME
          heroku config:set GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" --app $HEROKU_APP_NAME
          heroku config:set YOUTUBE_CHANNEL_ID="UCob5u7jsXrdca9vmarYJ0Cg" --app $HEROKU_APP_NAME

          # Deploy
          git subtree push --prefix proxy-server heroku main

      # Example: Deploy to custom server via SSH
      - name: Deploy to Custom Server
        if: false # Set to true to enable custom server deployment
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Deploy files
          rsync -avz -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ./proxy-server/ ${SERVER_USER}@${SERVER_HOST}:/opt/usmc-directives-proxy/

          # Set environment variables on remote server
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_HOST} << 'ENDSSH'
            cd /opt/usmc-directives-proxy

            # Create .env file with secrets
            cat > .env << EOF
YOUTUBE_API_KEY=${{ secrets.YOUTUBE_API_KEY }}
GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
YOUTUBE_CHANNEL_ID=UCob5u7jsXrdca9vmarYJ0Cg
EOF

            chmod 600 .env
            npm install --production
            pm2 restart usmc-directives-proxy || pm2 start server.js --name usmc-directives-proxy
ENDSSH

      - name: Deployment Summary
        run: |
          echo "âœ… Deployment completed!"
          echo "ðŸ” API keys loaded from GitHub Secrets"
          echo "ðŸ“¡ Server will use YOUTUBE_API_KEY and GEMINI_API_KEY from environment"
