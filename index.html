<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MARADMIN Tracker - Last 7 Days</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

```
:root {
  --bg-primary: #ffffff;
  --bg-secondary: #f5f5f5;
  --text-primary: #1a1a1a;
  --text-secondary: #666666;
  --accent: #cc0000;
  --border: #dddddd;
  --error-bg: #ffebee;
  --error-text: #c62828;
}

body.dark-theme {
  --bg-primary: #1a1a1a;
  --bg-secondary: #2a2a2a;
  --text-primary: #e0e0e0;
  --text-secondary: #b0b0b0;
  --accent: #ff3333;
  --border: #444444;
  --error-bg: #3a1a1a;
  --error-text: #ff6666;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background-color: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.6;
  transition: background-color 0.3s, color 0.3s;
}

header {
  background-color: var(--accent);
  color: white;
  padding: 2rem 1rem;
  text-align: center;
}

header h1 {
  font-size: 2rem;
  margin-bottom: 0.5rem;
}

header p {
  font-size: 1rem;
  margin-bottom: 1.5rem;
  opacity: 0.9;
}

.controls {
  display: flex;
  gap: 1rem;
  justify-content: center;
  flex-wrap: wrap;
}

button {
  background-color: white;
  color: var(--accent);
  border: 2px solid white;
  padding: 0.75rem 1.5rem;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  border-radius: 4px;
  transition: all 0.2s;
}

button:hover {
  background-color: transparent;
  color: white;
}

button:active {
  transform: scale(0.98);
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

main {
  max-width: 1200px;
  margin: 2rem auto;
  padding: 0 1rem;
}

.status {
  background-color: var(--bg-secondary);
  padding: 1rem;
  border-radius: 4px;
  margin-bottom: 1.5rem;
  font-weight: 600;
  text-align: center;
}

.error {
  background-color: var(--error-bg);
  color: var(--error-text);
  padding: 1rem;
  border-radius: 4px;
  margin-bottom: 1.5rem;
  border-left: 4px solid var(--error-text);
}

.error.hidden {
  display: none;
}

.results {
  display: grid;
  gap: 1.5rem;
}

.maradmin {
  background-color: var(--bg-secondary);
  padding: 1.5rem;
  border-radius: 4px;
  border-left: 4px solid var(--accent);
  transition: transform 0.2s, box-shadow 0.2s;
}

.maradmin:hover {
  transform: translateX(4px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.maradmin h2 {
  font-size: 1.25rem;
  margin-bottom: 0.5rem;
  color: var(--text-primary);
}

.maradmin h2 a {
  color: var(--accent);
  text-decoration: none;
}

.maradmin h2 a:hover {
  text-decoration: underline;
}

.maradmin p {
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
}

.maradmin .summary {
  margin-top: 0.75rem;
  font-style: italic;
  color: var(--text-secondary);
}

footer {
  background-color: var(--bg-secondary);
  padding: 2rem 1rem;
  text-align: center;
  margin-top: 3rem;
  border-top: 1px solid var(--border);
}

footer p {
  margin-bottom: 0.5rem;
  color: var(--text-secondary);
}

footer a {
  color: var(--accent);
  text-decoration: none;
}

footer a:hover {
  text-decoration: underline;
}

@media (max-width: 768px) {
  header h1 {
    font-size: 1.5rem;
  }

  .controls {
    flex-direction: column;
    align-items: stretch;
  }

  button {
    width: 100%;
  }

  .maradmin h2 {
    font-size: 1.1rem;
  }
}
```

  </style>
</head>
<body>
  <header>
    <h1>MARADMIN Tracker</h1>
    <p>Displays all MARADMINs published on Marines.mil within the last 7 days</p>
    <div class="controls">
      <button id="refreshBtn">Refresh</button>
      <button id="exportBtn">Export JSON</button>
      <button id="themeToggle">Toggle Theme</button>
    </div>
  </header>

  <main>
    <div id="status" class="status">Click Refresh to load data</div>
    <div id="error" class="error hidden"></div>
    <div id="results" class="results"></div>
  </main>

  <footer>
    <p>Data source: <a href="https://www.marines.mil/News/Messages/" target="_blank">Marines.mil Messages</a></p>
    <p>Last updated: <span id="lastUpdate">Never</span></p>
  </footer>

  <script>
    const CORS_PROXY = "https://api.allorigins.win/raw?url=";
    const RSS_URL = "https://www.marines.mil/DesktopModules/ArticleCS/RSS.ashx?ContentType=6&Site=481&max=50&category=14336";
    const MESSAGES_URL = "https://www.marines.mil/News/Messages/";
    const CACHE_KEY = "maradmin_cache";
    const CACHE_TIMESTAMP_KEY = "maradmin_cache_timestamp";

    const refreshBtn = document.getElementById("refreshBtn");
    const exportBtn = document.getElementById("exportBtn");
    const themeToggle = document.getElementById("themeToggle");
    const statusDiv = document.getElementById("status");
    const errorDiv = document.getElementById("error");
    const resultsDiv = document.getElementById("results");
    const lastUpdateSpan = document.getElementById("lastUpdate");

    let currentMaradmins = [];

    document.addEventListener("DOMContentLoaded", () => {
      loadThemePreference();
      loadCachedData();
    });

    refreshBtn.addEventListener("click", fetchMaradmins);
    exportBtn.addEventListener("click", exportToJSON);
    themeToggle.addEventListener("click", toggleTheme);

    async function fetchMaradmins() {
      setStatus("Fetching MARADMINs from RSS feed...");
      hideError();
      clearResults();
      refreshBtn.disabled = true;

      let maradmins = [];
      let fetchMethod = "";
      let rssError = null;

      try {
        const rssProxyURL = CORS_PROXY + encodeURIComponent(RSS_URL);
        const response = await fetch(rssProxyURL);
        
        if (response.ok) {
          const text = await response.text();
          maradmins = parseRSSFeed(text);
          fetchMethod = "RSS Feed";
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (err) {
        rssError = err.message;
        console.warn("RSS feed failed:", rssError);
        setStatus("RSS unavailable. Trying Messages page...");
        
        try {
          const htmlProxyURL = CORS_PROXY + encodeURIComponent(MESSAGES_URL);
          const response = await fetch(htmlProxyURL);
          
          if (response.ok) {
            const html = await response.text();
            maradmins = parseMessagesPage(html);
            fetchMethod = "Messages Page";
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (htmlErr) {
          showError(`Both methods failed. RSS: ${rssError}. HTML: ${htmlErr.message}`);
          refreshBtn.disabled = false;
          return;
        }
      }

      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      
      maradmins = maradmins.filter(item => {
        const pubDate = new Date(item.pubDate);
        return pubDate >= sevenDaysAgo;
      });

      maradmins.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));

      currentMaradmins = maradmins;
      cacheData(maradmins);

      if (maradmins.length === 0) {
        setStatus("No MARADMINs found in the last 7 days.");
      } else {
        setStatus(`Loaded ${maradmins.length} MARADMIN${maradmins.length === 1 ? '' : 's'} via ${fetchMethod}`);
        renderMaradmins(maradmins);
      }

      updateLastUpdateTime();
      refreshBtn.disabled = false;
    }

    function parseRSSFeed(xmlText) {
      const parser = new DOMParser();
      const xml = parser.parseFromString(xmlText, "application/xml");
      
      const parseError = xml.querySelector("parsererror");
      if (parseError) {
        throw new Error("XML parse error");
      }

      const items = xml.querySelectorAll("item");
      const maradmins = [];

      items.forEach(item => {
        const title = item.querySelector("title")?.textContent || "";
        const link = item.querySelector("link")?.textContent || "";
        const pubDate = item.querySelector("pubDate")?.textContent || "";
        const description = item.querySelector("description")?.textContent || "";

        const idMatch = title.match(/MARADMIN\s+\d+\/\d+/i);
        if (!idMatch) return;

        const summary = extractFirstSentence(description);

        maradmins.push({
          id: idMatch[0].toUpperCase(),
          title: title.trim(),
          link: link.trim(),
          pubDate: new Date(pubDate).toISOString(),
          summary: summary
        });
      });

      return maradmins;
    }

    function parseMessagesPage(html) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, "text/html");
      const maradmins = [];

      const links = doc.querySelectorAll("a");

      links.forEach(link => {
        const title = link.textContent.trim();
        const href = link.getAttribute("href");
        
        if (!title || !href) return;

        const idMatch = title.match(/MARADMIN\s+\d+\/\d+/i);
        if (!idMatch) return;

        const article = link.closest("article") || link.closest("li") || link.closest("div");
        const timeElement = article?.querySelector("time");
        
        let pubDate = new Date();
        if (timeElement) {
          const datetime = timeElement.getAttribute("datetime") || timeElement.textContent;
          pubDate = new Date(datetime);
        }

        const fullLink = href.startsWith("http") ? href : `https://www.marines.mil${href}`;

        maradmins.push({
          id: idMatch[0].toUpperCase(),
          title: title,
          link: fullLink,
          pubDate: pubDate.toISOString(),
          summary: ""
        });
      });

      return maradmins;
    }

    function extractFirstSentence(text) {
      if (!text) return "";
      
      const cleaned = text.replace(/<[^>]*>/g, "").trim();
      const match = cleaned.match(/^[^.!?]+[.!?]/);
      
      return match ? match[0].trim() : cleaned.substring(0, 150) + "...";
    }

    function renderMaradmins(maradmins) {
      clearResults();

      maradmins.forEach(item => {
        const div = document.createElement("div");
        div.className = "maradmin";

        const h2 = document.createElement("h2");
        h2.innerHTML = `${item.id}: <a href="${item.link}" target="_blank" rel="noopener noreferrer">${item.title}</a>`;

        const datePara = document.createElement("p");
        datePara.innerHTML = `<strong>Published:</strong> ${new Date(item.pubDate).toUTCString()}`;

        div.appendChild(h2);
        div.appendChild(datePara);

        if (item.summary) {
          const summaryPara = document.createElement("p");
          summaryPara.className = "summary";
          summaryPara.textContent = item.summary;
          div.appendChild(summaryPara);
        }

        resultsDiv.appendChild(div);
      });
    }

    function cacheData(data) {
      try {
        localStorage.setItem(CACHE_KEY, JSON.stringify(data));
        localStorage.setItem(CACHE_TIMESTAMP_KEY, new Date().toISOString());
      } catch (e) {
        console.warn("Cache failed:", e);
      }
    }

    function loadCachedData() {
      try {
        const cached = localStorage.getItem(CACHE_KEY);
        const timestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);

        if (cached && timestamp) {
          currentMaradmins = JSON.parse(cached);
          renderMaradmins(currentMaradmins);
          setStatus(`Showing cached data from ${new Date(timestamp).toLocaleString()}`);
          lastUpdateSpan.textContent = new Date(timestamp).toLocaleString();
        }
      } catch (e) {
        console.warn("Cache load failed:", e);
      }
    }

    function exportToJSON() {
      if (currentMaradmins.length === 0) {
        showError("No data to export. Click Refresh first.");
        return;
      }

      const dataStr = JSON.stringify(currentMaradmins, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement("a");
      a.href = url;
      a.download = `maradmins_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function toggleTheme() {
      document.body.classList.toggle("dark-theme");
      const isDark = document.body.classList.contains("dark-theme");
      localStorage.setItem("theme", isDark ? "dark" : "light");
    }

    function loadThemePreference() {
      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "dark") {
        document.body.classList.add("dark-theme");
      }
    }

    function setStatus(message) {
      statusDiv.textContent = message;
    }

    function showError(message) {
      errorDiv.textContent = `Error: ${message}`;
      errorDiv.classList.remove("hidden");
    }

    function hideError() {
      errorDiv.classList.add("hidden");
    }

    function clearResults() {
      resultsDiv.innerHTML = "";
    }

    function updateLastUpdateTime() {
      lastUpdateSpan.textContent = new Date().toLocaleString();
    }
  </script>

</body>
</html>
